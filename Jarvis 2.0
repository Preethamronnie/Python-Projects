import tkinter as tk
from tkinter import scrolledtext, messagebox
from datetime import datetime
from openai import OpenAI
import threading

# ===================== AI INITIALIZATION ===================== #

client = OpenAI()

SYSTEM_PROMPT = (
    "You are Jarvis, an intelligent, polite AI assistant. "
    "You help with general queries and technical questions. "
    "Be concise, accurate, and professional."
)

conversation = [{"role": "system", "content": SYSTEM_PROMPT}]

# ===================== AI RESPONSE FUNCTION ===================== #

def get_ai_response(user_input):
    try:
        conversation.append({"role": "user", "content": user_input})

        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=conversation,
            temperature=0.6
        )

        reply = response.choices[0].message.content.strip()
        conversation.append({"role": "assistant", "content": reply})
        return reply

    except Exception as e:
        return "Sorry, I am having trouble connecting to the AI service."

# ===================== GUI MESSAGE HANDLING ===================== #

def send_message(event=None):
    user_input = user_entry.get().strip()
    if not user_input:
        return

    display_message("You", user_input)
    user_entry.delete(0, tk.END)

    if user_input.lower() in ["bye", "exit", "quit", "goodbye"]:
        display_message("Jarvis", "Goodbye! Have a great day.")
        return

    threading.Thread(target=process_response, args=(user_input,), daemon=True).start()

def process_response(user_input):
    show_typing(True)

    if "time" in user_input.lower():
        reply = f"The current time is {datetime.now().strftime('%I:%M %p')}"
    elif "date" in user_input.lower() or "day" in user_input.lower():
        reply = f"Today is {datetime.now().strftime('%A, %B %d, %Y')}"
    else:
        reply = get_ai_response(user_input)

    show_typing(False)
    display_message("Jarvis", reply)

# ===================== UI HELPERS ===================== #

def display_message(sender, message):
    chat_area.config(state=tk.NORMAL)
    chat_area.insert(tk.END, f"{sender}: {message}\n\n")
    chat_area.config(state=tk.DISABLED)
    chat_area.yview(tk.END)

def show_typing(show):
    chat_area.config(state=tk.NORMAL)
    if show:
        chat_area.insert(tk.END, "Jarvis is typing...\n")
    else:
        chat_area.delete("end-2l", "end-1l")
    chat_area.config(state=tk.DISABLED)

def clear_chat():
    if messagebox.askyesno("Clear Chat", "Do you want to clear the conversation?"):
        chat_area.config(state=tk.NORMAL)
        chat_area.delete("1.0", tk.END)
        chat_area.config(state=tk.DISABLED)

        conversation.clear()
        conversation.append({"role": "system", "content": SYSTEM_PROMPT})
        display_message("Jarvis", "Conversation reset. How can I help you?")

# ===================== GUI SETUP ===================== #

root = tk.Tk()
root.title("JARVIS â€“ AI Assistant")
root.geometry("700x550")
root.resizable(False, False)

chat_area = scrolledtext.ScrolledText(
    root,
    wrap=tk.WORD,
    font=("Segoe UI", 11),
    state=tk.DISABLED
)
chat_area.pack(padx=10, pady=10, fill=tk.BOTH, expand=True)

user_entry = tk.Entry(root, font=("Segoe UI", 11))
user_entry.pack(padx=10, pady=5, fill=tk.X)
user_entry.bind("<Return>", send_message)

button_frame = tk.Frame(root)
button_frame.pack(pady=5)

send_btn = tk.Button(
    button_frame,
    text="Send",
    width=12,
    command=send_message
)
send_btn.pack(side=tk.LEFT, padx=5)

clear_btn = tk.Button(
    button_frame,
    text="Clear Chat",
    width=12,
    command=clear_chat
)
clear_btn.pack(side=tk.LEFT, padx=5)

display_message("Jarvis", "Hello! I am ready to assist you.")

root.mainloop()
